# 错误

本章提供了 Google API 错误模型的概述以及开发人员如何正确生成和处理错误的通用指导。

Google API 使用简单的协议无关的错误模型，这使我们能够在不同的 API 协议（如gRPC或HTTP）以及错误上下文（例如异步，批处理或工作流错误）中得到一致的体验。

## 错误模型

错误模型在逻辑上由 `google.rpc.Status` 定义，当发生 API 错误时，返回该模型的一个实例给客户端。 以下代码片段展示了错误模型的总体设计：
```proto3
package google.rpc;

message Status {
  // 一个简单的错误代码，可以很容易地由客户端处理。 实际的错误代码由“google.rpc.Code”定义。
  int32 code = 1;

  // 面向开发人员的可读取的英文错误消息。 它应该不解释错误，并提供可行的解决方案。
  string message = 2;

  // 客户端代码可用于处理错误的其他错误信息，例如延迟重试或提供帮助链接。
  repeated google.protobuf.Any details = 3;
}
```

由于大多数 Google API 都使用面向资源的 API 设计，所以错误处理遵循相同的设计原则，通过使用一小批标准错误来设置大量资源的错误。例如，服务器不是定义不同种类的“未找到”错误，而是使用一个标准的 `google.rpc.Code.NOT_FOUND` 错误代码，告诉客户端没有找到哪个特定的资源。较小的状态空间降低了文档的复杂性，在客户端库中提供了更好的惯用映射，并降低了客户端逻辑复杂性，同时不限制可操作信息的包含。

## 错误码

Google API 必须使用 `google.rpc.Code` 定义的规范错误代码。个人的 API 应避免定义其他错误代码，因为开发人员不太可能会写逻辑来处理大量的错误代码。作为参考，每个API调用平均处理3个错误代码意味着大多数应用程序逻辑只是用于错误处理，这不是一个好的开发者体验。

## 错误信息

错误消息可以帮助用户轻松快速地了解和解决API错误。一般来说，在撰写错误消息时，请考虑以下准则：

* 不要以为该用户是你的API的专家用户。用户可以是客户端开发人员，操作人员，IT人员或应用程序的最终用户。
* 不要以为用户了解您的服务实现或熟悉错误的上下文（如日志分析）。
* 如果可能，应构建技术用户（但不一定是API的开发人员）可以对错误进行响应并进行更正的错误消息。
* 保持错误消息简短。如果需要，请提供一个链接，让困惑的读者可以提出问题，提供反馈或获取不完全符合错误信息的更多信息。或者，使用详细信息字段展开。

## 错误详情

Google API定义了一组错误详细信息的标准错误有效内容，您可以在 [google/rpc/error_details.proto](https://github.com/googleapis/googleapis/blob/master/google/rpc/error_details.proto) 中找到。这些涵盖了API错误的最常见需求，例如磁盘配额失败和无效参数。像错误代码一样，错误详情应尽可能使用这些标准的有效内容。

只有在辅助应用程序代码来处理错误时，才应引入其他错误详细信息类型。如果错误信息只能由人类处理，请依赖于错误消息内容，让开发人员手动处理，而不是引入新的错误详细信息类型。请注意，如果引入了其他错误详细信息类型，则必须明确注册它们。

以下是一些示例 `error_details` 的有效内容：
* RetryInfo 描述客户端可以重试失败的请求，可能会在 `Code.UNAVAILABLE` 或 `Code.ABORTED` 上返回。
* QuotaFailure 描述硬盘配额检查如何失败，可能会在 `Code.RESOURCE_EXHAUSTED` 上返回。
* BadRequest 描述客户端请求中的违规行为，可能会在 `Code.INVALID_ARGUMENT` 上返回。